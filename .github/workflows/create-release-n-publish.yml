name: Create Release and Publish Package
on:
  push:
    branches: [ "main" ]
jobs:
  build:
    name: Create Release and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Get branch names
        id: branch-name
        uses: tj-actions/branch-names@v6
      - name: Update version.py
        run: |
          export PYTHONPATH=$PYTHONPATH:flowcept
          export BRANCH_NAME="${{ steps.branch-name.outputs.current_branch }}" 
          python .github/workflows/version_bumper.py
      - name: Commit new version
        run: |
          git config --global user.name 'Flowcept CI Bot'
          git config --global user.email 'flowcept@users.noreply.github.com'
          git branch
          git add flowcept/version.py
          git commit -m "Flowcept CI Bot: bumping master version"
          git push --force
      - name: Create Release
        run: |
            export PYTHONPATH=$PYTHONPATH:flowcept
            export CURRENT_VERSION=`python -c "from flowcept import __version__; print(__version__)"`
            echo $CURRENT_VERSION
          
            REPOSITORY=${{ github.repository }}
            ACCESS_TOKEN=${{ secrets.GITHUB_TOKEN  }}
            TARGET=${{ steps.branch-name.outputs.current_branch }}
            echo "REPOSITORY=$REPOSITORY"
            echo "TARGET=$TARGET"
            echo "CURRENT_VERSION=${CURRENT_VERSION}"
            echo "Now run curl"
            curl --data "{\"tag_name\": \"v${CURRENT_VERSION}\",
                            \"target_commitish\": \"${TARGET}\",
                            \"name\": \"v${CURRENT_VERSION}\",
                            \"body\": \"Release of version ${CURRENT_VERSION}\",
                            \"make_latest\": \"true\",
                            \"draft\": false,
                            \"prerelease\": false}" \
                -H "Authorization: Bearer ${ACCESS_TOKEN}" \
                https://api.github.com/repos/${REPOSITORY}/releases
      - name: Install pypa/build
        run: >-
          python -m
          pip install
          build
          --user
      - name: Build a binary wheel and a source tarball
        run: >-
          python -m
          build
          --sdist
          --wheel
          --outdir dist/
          .
      - name: Publish distribution to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/
          verbose: true
      - name: Publish distribution to PyPI
        if: startsWith(github.ref, 'refs/tags')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          verbose: true
